---
title: "Main and sensitivity analyses"
author: "Kate Tran"
date: "2022-11-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(lme4)
library(sjPlot)

source("../utility_fun.R")
```

# Read the data
```{r}
# 11 SITES
# climate_data <- readRDS("../data/dataset_14d_4to10_11sites.rds")
# In the sensitivity analysis
# climate_data_sens <- readRDS("../data/dataset_14d_5to9_11sites.rds")
# climate_data_beforeCovid <- climate_data %>% filter(year_14d < 2020)
# 21 SITES - USE THIS DATA INSTEAD AND RUN ALL MODELS BELOW
climate_data <- readRDS("../data/dataset_14d_4to10_21sites.rds")
climate_data_sens <- readRDS("../data/dataset_14d_5to9_21sites.rds")
climate_data_beforeCovid <- climate_data %>% filter(year_14d < 2020)
```

# Define variables/covariates
```{r}
var_headache_0 <- c("(1 | site_id_l_br/rel_family_id/src_subject_id)")
# var_covariates_0 <- c("scale(interview_age)", "scale(interview_age)^2", "scale(interview_age)^3", "sex_br")
# var_covariates_1 <- c("scale(interview_age)", "scale(interview_age)^2", "scale(interview_age)^3", "sex_br", "race_black", "race_white", "ethnicity_hisp")
var_covariates_1 <- c("scale(interview_age)", "scale(interview_age)^2", "scale(interview_age)^3", "sex_br", "race_black", "race_white", "ethnicity_hisp", "scale(household_income)")
# var_covariates_3 <- c(var_covariates_2, "scale(reshist_addr1_d1a)") # Residential history derived - gross residential density
# var_covariates_4 <- c(var_covariates_2, "scale(reshist_addr1_walkindex)")
# var_covariates_5 <- c(var_covariates_2, "scale(reshist_addr1_popdensity)")
# var_covariates_6 <- c(var_covariates_2, "scale(reshist_addr1_d1a)", "scale(reshist_addr1_walkindex)")
var_covariates_2 <- c(var_covariates_1, "scale(reshist_addr1_d1a)", "scale(reshist_addr1_walkindex)", "scale(reshist_addr1_popdensity)")
```

# Analysis
## Main analysis: combined past/current externalizing symptoms (ksads_externalizing_exclude_attentation_symptoms_sum)
```{r}
mod_ksads_0 <- lmer(models(outcome = "scale(ksads_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                           variables = var_headache_0, var_added = NULL), data = climate_data, 
                    control=lmerControl(check.nobs.vs.nlev = "ignore",
                                        check.nobs.vs.rankZ = "ignore",
                                        check.nobs.vs.nRE="ignore",
                                        optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

mod_ksads_1 <- lmer(models(outcome = "scale(ksads_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                           variables = var_headache_0, var_added = var_covariates_1), data = climate_data, 
                    control=lmerControl(check.nobs.vs.nlev = "ignore",
                                        check.nobs.vs.rankZ = "ignore",
                                        check.nobs.vs.nRE="ignore",
                                        optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

mod_ksads_2 <- lmer(models(outcome = "scale(ksads_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                           variables = var_headache_0, var_added = var_covariates_2), data = climate_data, 
                    control=lmerControl(check.nobs.vs.nlev = "ignore",
                                        check.nobs.vs.rankZ = "ignore",
                                        check.nobs.vs.nRE="ignore",
                                        optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

# Table 2
tab_model(mod_ksads_0, mod_ksads_1, mod_ksads_2, show.intercept = F)
```


## Main analysis: outcome lifetime suicide attempt (SA_y)
```{r}
# Table 3
mod_SA_0 <- glmer(models(outcome = "SA_y", predictor = "scale(dx90)", variables = var_headache_0, var_added = NULL), 
                  data = climate_data, family = binomial, nAGQ = 0)

mod_SA_1 <- glmer(models(outcome = "SA_y", predictor = "scale(dx90)", variables = var_headache_0, var_added = var_covariates_1), 
                  data = climate_data, family = binomial, nAGQ = 0)

mod_SA_2 <- glmer(models(outcome = "SA_y", predictor = "scale(dx90)", variables = var_headache_0, var_added = var_covariates_2), 
                  data = climate_data, family = binomial, nAGQ = 0)

tab_model(mod_SA_0, mod_SA_1, mod_SA_2, show.intercept = F)
```


## Sensitivity analysis: before Covid
```{r}
mod_beforeCovid_ksads_0 <- lmer(models(outcome = "scale(ksads_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                                       variables = var_headache_0, var_added = NULL), data = climate_data_beforeCovid, 
                                control=lmerControl(check.nobs.vs.nlev = "ignore",
                                                    check.nobs.vs.rankZ = "ignore",
                                                    check.nobs.vs.nRE="ignore",
                                                    optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

mod_beforeCovid_ksads_1 <- lmer(models(outcome = "scale(ksads_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                                       variables = var_headache_0, var_added = var_covariates_1), data = climate_data_beforeCovid, 
                                control=lmerControl(check.nobs.vs.nlev = "ignore",
                                                    check.nobs.vs.rankZ = "ignore",
                                                    check.nobs.vs.nRE="ignore",
                                                    optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

mod_beforeCovid_ksads_2 <- lmer(models(outcome = "scale(ksads_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                                       variables = var_headache_0, var_added = var_covariates_2), data = climate_data_beforeCovid, 
                                control=lmerControl(check.nobs.vs.nlev = "ignore",
                                                    check.nobs.vs.rankZ = "ignore",
                                                    check.nobs.vs.nRE="ignore",
                                                    optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

# Table S4
tab_model(mod_beforeCovid_ksads_0, mod_beforeCovid_ksads_1, mod_beforeCovid_ksads_2, show.intercept = F)
```

## Sensitivity analysis: May to Sep data
```{r}
mod_MaySep_ksads_0 <- lmer(models(outcome = "scale(ksads_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                                  variables = var_headache_0, var_added = NULL), data = climate_data_sens, 
                           control=lmerControl(check.nobs.vs.nlev = "ignore",
                                               check.nobs.vs.rankZ = "ignore",
                                               check.nobs.vs.nRE="ignore",
                                               optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

mod_MaySep_ksads_1 <- lmer(models(outcome = "scale(ksads_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                                  variables = var_headache_0, var_added = var_covariates_1), data = climate_data_sens, 
                           control=lmerControl(check.nobs.vs.nlev = "ignore",
                                               check.nobs.vs.rankZ = "ignore",
                                               check.nobs.vs.nRE="ignore",
                                               optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

mod_MaySep_ksads_2 <- lmer(models(outcome = "scale(ksads_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                                  variables = var_headache_0, var_added = var_covariates_2), data = climate_data_sens, 
                           control=lmerControl(check.nobs.vs.nlev = "ignore",
                                               check.nobs.vs.rankZ = "ignore",
                                               check.nobs.vs.nRE="ignore",
                                               optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))


# Table S5
tab_model(mod_MaySep_ksads_0, mod_MaySep_ksads_1, mod_MaySep_ksads_2, show.intercept = F)
```

## Sensitivity analysis: outcome Present Ksad externalizing symptoms
```{r}
mod_ksads_current_0 <- lmer(models(outcome = "scale(ksads_present_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                                   variables = var_headache_0, var_added = NULL), data = climate_data, 
                            control=lmerControl(check.nobs.vs.nlev = "ignore",
                                                check.nobs.vs.rankZ = "ignore",
                                                check.nobs.vs.nRE="ignore",
                                                optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

mod_ksads_current_1 <- lmer(models(outcome = "scale(ksads_present_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                                   variables = var_headache_0, var_added = var_covariates_1), data = climate_data, 
                            control=lmerControl(check.nobs.vs.nlev = "ignore",
                                                check.nobs.vs.rankZ = "ignore",
                                                check.nobs.vs.nRE="ignore",
                                                optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

mod_ksads_current_2 <- lmer(models(outcome = "scale(ksads_present_externalizing_exclude_attentation_symptoms_sum)", predictor = "scale(dx90)", 
                                   variables = var_headache_0, var_added = var_covariates_2), data = climate_data, 
                            control=lmerControl(check.nobs.vs.nlev = "ignore",
                                                check.nobs.vs.rankZ = "ignore",
                                                check.nobs.vs.nRE="ignore",
                                                optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)))

# Table S6
tab_model(mod_ksads_current_0, mod_ksads_current_1, mod_ksads_current_2, show.intercept = F)
```

## Sensitivity analysis: outcome SA_current_y
```{r}
mod_SA_current_0 <- glmer(models(outcome = "SA_current_y", predictor = "scale(dx90)", variables = var_headache_0, var_added = NULL), 
                          data = climate_data, family = binomial, nAGQ = 0)

mod_SA_current_1 <- glmer(models(outcome = "SA_current_y", predictor = "scale(dx90)", variables = var_headache_0, var_added = var_covariates_1),
                          data = climate_data, family = binomial, nAGQ = 0)

mod_SA_current_2 <- glmer(models(outcome = "SA_current_y", predictor = "scale(dx90)", variables = var_headache_0, var_added = var_covariates_2),
                          data = climate_data, family = binomial, nAGQ = 0)

# Table S7
tab_model(mod_SA_current_0, mod_SA_current_1, mod_SA_current_2, show.intercept = F)
```















