---
title: "Create plots"
author: "Kate Tran"
date: "2022-12-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(lubridate)
library(usmap)
library(usmapdata)
```

```{r}
climate_data <- readRDS("../data/dataset_14d_4to10.rds") %>% 
  mutate(eventname = recode(eventname,
                            baseline_year_1_arm_1 = "bl" ,
                            `1_year_follow_up_y_arm_1` = "1y",
                            `2_year_follow_up_y_arm_1` = "2y"),
         eventname = factor(eventname, c("bl", "1y", "2y")))
```

```{r}
# Number of participants across months
ggplot(climate_data) + aes(x = format(mdy(interview_date), "%Y-%m")) +
  geom_bar(fill = "royalblue4") +
  labs(x = "",
       y = "Number of participants") +
  scale_y_continuous(breaks=seq(0, 1000, 200)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14)
  )

# ggsave("../plots/participants_across_time.tiff", dpi = 400, width = 6, height = 4)
```


```{r}
# Map of stations
statelists <- data.frame(
  stringsAsFactors = FALSE,
             state = c("Florida", "Oklahoma", "California", "Oregon", "Colorado", 
                       "Maryland", "Michigan", "Utah", "Wisconsin", "Missouri"),
         stateabbr = c("FL", "OK", "CA", "OR", "CO", "MD", "MI", "UT", "WI", "MO"),
                 N = rep(1L, 10),
              fips = c("12", "40", "06", "41", "08", "24", "26", "49", "55", "29")
  )

# Get centroids
centroid_labels <- centroid_labels("states") #usmapdata

statelists <- statelists %>% 
  bind_rows(centroid_labels %>% select(state = full, stateabbr = abbr, fips) %>% 
  mutate(N = 0) %>% 
  filter(
    !state %in% c("Florida", "Oklahoma", "California", "Oregon", "Colorado", 
                       "Maryland", "Michigan", "Utah", "Wisconsin", "Missouri")
  ))

site_data <- data.frame(lon = c(-80.38360, -95.99016, -122.68940, -122.14020, -118.44270, -105.26670, -76.61110, -83.69330, -111.83209, -88.02953, -90.27077),
                        lat = c(25.75530, 36.04243, 45.51810, 37.44360, 34.06970, 39.99190, 39.28140, 42.24160, 40.81496, 43.07211, 38.63079))

transformed_data <- usmap_transform(site_data)

site_data <- data.frame(lon = c(-80.38360, -95.99016, -122.68940, -122.14020, -118.44270, -105.26670, -76.61110, -83.69330, -111.83209, -88.02953, -90.27077),
                        lat = c(25.75530, 36.04243, 45.51810, 37.44360, 34.06970, 39.99190, 39.28140, 42.24160, 40.81496, 43.07211, 38.63079))

transformed_data <- usmap_transform(site_data)

# create plot
plot_usmap(data = statelists, regions = "state", values = "N") +
  scale_fill_continuous(low = "azure", high = "azure", limits = c(0,2)) + #high = "lightblue3", 
  labs(title = "", #The ABCD research sites used in this study
       caption = "",
       fill = "Count") +
  theme(panel.background = element_rect(color = "black", fill = "white"),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, face = "bold", size = 15)) +
  geom_point(data = transformed_data, 
             aes(x = x, y = y), 
             color = "red",
             size = 5,
             shape = 17) +
  annotate(geom = "text", x = 2242731, y = -1909255.3, label = 'bold("(1-31)*")', color = "blue", size = 5, parse = TRUE) +
  annotate(geom = "text", x = 261461.6, y = -1136424.8, label = 'bold("(1-28)*")', color = "blue", size = 5, parse = TRUE) +
  annotate(geom = "text", x = -1738709.7, y = 154836.9, label = 'bold("(1-10)*")', color = "blue", size = 5, parse = TRUE) +
  annotate(geom = "text", x = -1730656, y = -721391.9, label = 'bold("(2-7)*")', color = "blue", size = 5, parse = TRUE) +
  annotate(geom = "text", x = -1510056, y = -1173855, label = 'bold("(1-7)*")', color = "blue", size = 5, parse = TRUE) +
  annotate(geom = "text", x = -448725.6, y = -692423.5, label = 'bold("(4-22)*")', color = "blue", size = 5, parse = TRUE) +
  annotate(geom = "text", x = 2362549, y = -352730.3, label = 'bold("(1-22)*")', color = "blue", size = 5, parse = TRUE) +
  annotate(geom = "text", x = 1466727, y = -303404.1, label = 'bold("(1-11)*")', color = "blue", size = 5, parse = TRUE) +
  annotate(geom = "text", x = -992155.1, y = -543883.8, label = 'bold("(1-26)*")', color = "blue", size = 5, parse = TRUE) +
  annotate(geom = "text", x = 780130.3, y = -38193, label = 'bold("(1-5)*")', color = "blue", size = 5, parse = TRUE) +
  annotate(geom = "text", x = 674046.2, y = -798478.2, label = 'bold("(7-20)*")', color = "blue", size = 5, parse = TRUE) +
  # Add the footnotes
  annotate(geom = "text", x = 861461.6, y = -2519255, label= 'bold("* Range (min-max) of extreme heat days (days/month)")', color = "blue", size = 3, parse = TRUE) +
  geom_point(data = data.frame(x = -118538.4, y = -2659255), aes(x = x, y = y),  color = "red", size = 4, shape = 17) +
  annotate(geom = "text", x = 288538.4, y = -2659255, label= 'bold("Weather stations")', color = "blue", size = 3, parse = TRUE)


ggsave("../plots/map1.tiff", dpi = 600, width = 8, height = 6)
```























